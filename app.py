import streamlit as st
# -*- coding: utf-8 -*-
"""è¨ˆç¨‹å°ˆé¡Œ_0.3

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Es3Zjjx3tgsdTJmII0jFjXjwZo-d14dy
"""

import streamlit as st
import matplotlib.pyplot as plt
import pandas as pd
import seaborn as sns
import requests
from io import BytesIO
import time
import os
from typing import List, Optional, Tuple, Dict
from matplotlib.font_manager import FontProperties
import urllib3 
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# ----------------------------------------------------
# 0. STREAMLIT å…¨åŸŸè¨­å®šèˆ‡å­—å‹è™•ç†
# ----------------------------------------------------

st.set_page_config(layout="wide", page_title="å»¢æ£„ç‰©æ•¸æ“šå¯è¦–åŒ–å„€è¡¨æ¿")

# --- Streamlit å­—å‹è¼‰å…¥èˆ‡è¨­ç½® ---
font_path = "NotoSansTC-Regular.ttf"
font1: Optional[FontProperties] = None

# æª¢æŸ¥è·¯å¾‘
if os.path.exists(font_path):
    font1 = FontProperties(fname=font_path)
    plt.rcParams['font.sans-serif'] = [font1.get_name()] + plt.rcParams['font.sans-serif']
else:
    plt.rcParams['font.sans-serif'] = ['Arial Unicode MS', 'Microsoft JhengHei', 'SimHei']

plt.rcParams['axes.unicode_minus'] = False

# --- çˆ¬èŸ²è¨­å®š ---
BASE_URL = "https://waste3.moenv.gov.tw/download/waste_web/statistics_file/month/city_output"
HEADERS = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
}

# ----------------------------------------------------
# 1. è³‡æ–™çˆ¬å–èˆ‡æ¸…ç†å‡½å¼ (Cached Function)
# ----------------------------------------------------

@st.cache_data(ttl="1h", show_spinner=False) # é—œé–‰å…§å»º spinnerï¼Œè‡ªå·±æ§åˆ¶é€²åº¦æ¢
def get_final_data(target_ym_list: List[str]):
    """æ ¹æ“šå¹´æœˆä»£ç¢¼æŠ“å–ã€æ¸…ç†ä¸¦æ•´åˆè³‡æ–™ (å·²å¿«å–)ã€‚"""

    st.info(f"ğŸ”— æ­£åœ¨æŠ“å–ä»¥ä¸‹å¹´æœˆè³‡æ–™: {target_ym_list}...", icon="âŒ›")

    all_dataframes: List[pd.DataFrame] = []

    # ä½¿ç”¨ Streamlit çš„é€²åº¦æ¢å’Œç‹€æ…‹æ¢
    status_container = st.container()
    progress_bar = status_container.progress(0, text="è³‡æ–™æŠ“å–ä¸­...")
    latest_status = status_container.empty()

    # --- æ‰¹æ¬¡ä¸‹è¼‰ã€æ¸…ç†èˆ‡æ•´åˆé‚è¼¯ ---
    for i, ym_code in enumerate(target_ym_list):
        target_url = f"{BASE_URL}{ym_code}.XLS"
        latest_status.text(f"âœ… æ­£åœ¨è™•ç† {ym_code}...")
        progress_bar.progress((i + 1) / len(target_ym_list))

        try:
            response = requests.get(target_url, headers=HEADERS, timeout=15, verify=False)
            time.sleep(0.5)

            if response.status_code == 200:
                data_io = BytesIO(response.content)
                df = pd.read_excel(data_io, sheet_name=0, header=[2, 3])

                # --- è™•ç†å¤šå±¤æ¬¡æ¨™é¡Œ ---
                if isinstance(df.columns, pd.MultiIndex):
                    super_header_level = df.columns.get_level_values(0)
                    sub_header_level = df.columns.get_level_values(1)
                    new_columns: List[str] = []

                    for idx, (super_h, sub_h) in enumerate(zip(super_header_level, sub_header_level)):

                        super_h_str = str(super_h).strip()
                        sub_h_str = str(sub_h).strip()

                        if idx == 0: new_columns.append('ç¸£å¸‚åˆ¥')
                        elif idx == 6: new_columns.append('å‰æœˆè²¯å­˜é‡(B)')
                        elif idx == 7: new_columns.append('æœ¬æœˆè²¯å­˜é‡(C)')
                        elif idx == 8: new_columns.append('è²¯å­˜ç•°å‹•é‡(D)=(C)-(B)')
                        elif idx == 9: new_columns.append('å»¢æ£„ç‰©ç”¢ç”Ÿé‡(E)=(A)+(D)')
                        else:
                            is_single_level = ('Unnamed' in super_h_str or super_h_str.lower() == 'nan' or super_h_str == '')

                            if 'nan' in super_h_str.lower() and idx > 0 and len(new_columns) > 0:
                                super_h_str = new_columns[-1].split(' - ')[0].split('(')[0].strip()

                            if is_single_level and ('Unnamed' in sub_h_str or sub_h_str.lower() == 'nan'): continue

                            if is_single_level:
                                new_columns.append(sub_h_str)
                            elif super_h_str == sub_h_str:
                                new_columns.append(super_h_str)
                            else:
                                new_columns.append(f"{super_h_str} - {sub_h_str}")

                    df.columns = new_columns
                else:
                    df.columns = [str(col).strip() for col in df.columns]

                df['å¹´æœˆä»£ç¢¼'] = ym_code
                all_dataframes.append(df)
                latest_status.success(f"âœ… {ym_code} è³‡æ–™è®€å–æˆåŠŸï¼")

            elif response.status_code == 404:
                latest_status.warning(f"âš ï¸ {ym_code} (404) è³‡æ–™å¯èƒ½å°šæœªç™¼å¸ƒã€‚")

        except Exception as e:
            latest_status.error(f"âŒ è™•ç† {ym_code} éŒ¯èª¤: {e}")
            st.exception(e) # é¡¯ç¤ºè©³ç´°çš„éŒ¯èª¤è¿½è¹¤

    progress_bar.empty()
    latest_status.empty() # æ¸…ç©ºæœ€çµ‚ç‹€æ…‹

    # å½™æ•´æ‰€æœ‰è³‡æ–™
    if all_dataframes:
        final_df = pd.concat(all_dataframes, ignore_index=True)
        final_df = final_df[~final_df['ç¸£å¸‚åˆ¥'].str.contains('åˆè¨ˆ|è¨»', na=False)]

        numeric_cols_final = []
        for col in final_df.columns:
            if col not in ['ç¸£å¸‚åˆ¥', 'å¹´æœˆä»£ç¢¼']:
                final_df[col] = pd.to_numeric(final_df[col], errors='coerce')
                numeric_cols_final.append(col)

        st.success("ğŸ‰ è³‡æ–™æŠ“å–èˆ‡æ¸…ç†å®Œæˆï¼Œé–‹å§‹åˆ†æï¼")
        return final_df, numeric_cols_final
    else:
        st.error("âŒ æœªèƒ½æˆåŠŸæŠ“å–ä»»ä½•è³‡æ–™ã€‚è«‹æª¢æŸ¥å¹´æœˆä»£ç¢¼æ˜¯å¦æ­£ç¢ºã€‚")
        return pd.DataFrame(), []

# ----------------------------------------------------
# 2. ç¹ªåœ–å‡½å¼ (Function returns Figure)
# ----------------------------------------------------

def create_single_month_ranking(data: pd.DataFrame, target_month: str, target_col: str):
    """åŠŸèƒ½ 1: å–®ä¸€æœˆä»½å„ç¸£å¸‚æ’å (å›å‚³ Figure)"""
    data = data[data['å¹´æœˆä»£ç¢¼'] == target_month].copy()
    if data.empty: return None
    data = data.sort_values(target_col, ascending=False)
    fig, ax = plt.subplots(figsize=(14, 7))
    bars = ax.bar(data['ç¸£å¸‚åˆ¥'], data[target_col], color='skyblue')
    if len(bars) > 3:
        bars[0].set_color('salmon')
        bars[1].set_color('orange')
        bars[2].set_color('gold')
    ax.set_title(f"{target_month} å„ç¸£å¸‚ - {target_col} æ’å", fontsize=16, fontproperties=font1)
    ax.set_xlabel("ç¸£å¸‚åˆ¥", fontsize=12, fontproperties=font1)
    ax.set_ylabel("æ•¸å€¼", fontsize=12, fontproperties=font1)
    ax.tick_params(axis='x', rotation=45)
    for label in ax.get_xticklabels(): label.set_fontproperties(font1)
    ax.grid(axis='y', linestyle='--', alpha=0.7)
    fig.tight_layout()
    return fig

def create_grouped_bar_comparison(data: pd.DataFrame, target_cities: List[str], target_col: str):
    """åŠŸèƒ½ 2: è·¨æœˆä¸¦æ’é•·æ¢åœ– (å›å‚³ Figure)"""
    plot_data = data[data['ç¸£å¸‚åˆ¥'].isin(target_cities)]
    if plot_data.empty: return None
    fig, ax = plt.subplots(figsize=(14, 8))
    sns.barplot(
        data=plot_data, x='ç¸£å¸‚åˆ¥', y=target_col, hue='å¹´æœˆä»£ç¢¼', palette='viridis', ax=ax
    )
    ax.set_title(f"{target_col} - è·¨æœˆä»½ä¸¦æ’æ¯”è¼ƒ", fontsize=16, fontproperties=font1)
    ax.set_ylabel(target_col, fontsize=12, fontproperties=font1)
    ax.set_xlabel("ç¸£å¸‚åˆ¥", fontsize=12, fontproperties=font1)
    ax.tick_params(axis='x', rotation=45)
    for label in ax.get_xticklabels(): label.set_fontproperties(font1)
    ax.legend(title='æœˆä»½', prop=font1)
    ax.grid(axis='y', linestyle='--', alpha=0.5)
    fig.tight_layout()
    return fig

def create_trend_comparison(data: pd.DataFrame, target_cities: List[str], target_col: str):
    """åŠŸèƒ½ 3: è·¨æœˆä»½è¶¨å‹¢æ¯”è¼ƒ (å›å‚³ Figure)"""
    if len(data['å¹´æœˆä»£ç¢¼'].unique()) < 2: return None
    plot_data = data[data['ç¸£å¸‚åˆ¥'].isin(target_cities)]
    if plot_data.empty: return None
    fig, ax = plt.subplots(figsize=(12, 6))
    sns.lineplot(
        data=plot_data, x='å¹´æœˆä»£ç¢¼', y=target_col, hue='ç¸£å¸‚åˆ¥', marker='o', linewidth=2, ax=ax
    )
    ax.set_title(f"{target_col} - è·¨æœˆä»½è¶¨å‹¢æ¯”è¼ƒ", fontsize=16, fontproperties=font1)
    ax.set_xlabel("æœˆä»½", fontsize=12, fontproperties=font1)
    ax.set_ylabel("æ•¸å€¼", fontsize=12, fontproperties=font1)
    ax.legend(prop=font1)
    ax.grid(True, linestyle='--', alpha=0.6)
    fig.tight_layout()
    return fig

# ----------------------------------------------------
# 3. STREAMLIT æ‡‰ç”¨ç¨‹å¼å…¥å£ (æ¨¡æ“¬ CLI è¼¸å…¥)
# ----------------------------------------------------

def parse_ym_input(input_str: str) -> List[str]:
    """å°‡é€—è™Ÿåˆ†éš”çš„å¹´æœˆå­—ä¸²è½‰æ›ç‚ºæœ‰æ•ˆçš„å¹´æœˆä»£ç¢¼åˆ—è¡¨"""
    if not input_str:
        return []
    target_ym_list = [
        ym.strip()
        for ym in input_str.split(',')
        if ym.strip().isdigit() and len(ym.strip()) == 5
    ]
    return target_ym_list

def streamlit_app():

    st.title('ğŸ—‘ï¸ å»¢æ£„ç‰©æ•¸æ“šå¯è¦–åŒ–å„€è¡¨æ¿')

    # --- Session State åˆå§‹åŒ– ---
    # ç”¨ä¾†è¨˜ä½è³‡æ–™æ˜¯å¦å·²ç¶“è¼‰å…¥æˆåŠŸ
    if 'data_loaded' not in st.session_state:
        st.session_state.data_loaded = False
        st.session_state.analysis_df = pd.DataFrame()
        st.session_state.numeric_cols = []
        st.session_state.month_input_str = "" # è¨˜ä½ä¸Šæ¬¡è¼¸å…¥çš„å¹´æœˆå­—ä¸²

    st.header("1. é¸æ“‡è³‡æ–™ç¯„åœ ")
    st.info("ğŸ’¡ è«‹è¼¸å…¥æƒ³æŠ“å–çš„å¹´æœˆä»£ç¢¼ï¼Œç”¨é€—è™Ÿåˆ†éš” (ä¾‹å¦‚ï¼š11405, 11404, 11312)")

    # æ¨¡æ“¬ CLI input()
    month_input_string = st.text_input(
        label="å¹´æœˆä»£ç¢¼è¼¸å…¥",
        value=st.session_state.month_input_str, # è¨˜ä½ä¸Šæ¬¡è¼¸å…¥çš„å€¼
        placeholder="ä¾‹å¦‚: 11405, 11404, 11312",
        key='month_input'
    )

    # æ¨¡æ“¬ CLI button/Enter éµ
    start_button = st.button("é–‹å§‹æŠ“å–/æ›´æ–°è³‡æ–™", type='primary')

    # --- æµç¨‹æ§åˆ¶ ---

    if start_button or st.session_state.data_loaded:

        # è§£æè¼¸å…¥ä¸¦æ›´æ–° Session State
        target_ym_selection = parse_ym_input(month_input_string)
        st.session_state.month_input_str = month_input_string

        if not target_ym_selection:
            st.error("âŒ è¼¸å…¥æ ¼å¼éŒ¯èª¤æˆ–ç‚ºç©ºã€‚è«‹ç¢ºèªè¼¸å…¥äº†äº”ä½æ•¸çš„å¹´æœˆä»£ç¢¼ï¼Œä¸¦ç”¨é€—è™Ÿåˆ†éš”ã€‚")
            st.session_state.data_loaded = False
            return

        # å‘¼å«å¿«å–å¾Œçš„è³‡æ–™è¼‰å…¥å‡½å¼
        analysis_df, numeric_cols = get_final_data(target_ym_selection)

        if analysis_df.empty or not numeric_cols:
            # éŒ¯èª¤å·²åœ¨ get_final_data å…§é¡¯ç¤º
            st.session_state.data_loaded = False
            return

        # è³‡æ–™è¼‰å…¥æˆåŠŸï¼Œæ›´æ–° Session State
        st.session_state.data_loaded = True
        st.session_state.analysis_df = analysis_df
        st.session_state.numeric_cols = numeric_cols

    # --- 2. å„€è¡¨æ¿åˆ†æå€ (åªæœ‰è³‡æ–™è¼‰å…¥æˆåŠŸæ‰é¡¯ç¤º) ---

    if st.session_state.data_loaded:

        analysis_df = st.session_state.analysis_df
        numeric_cols = st.session_state.numeric_cols

        st.header("2. æ•¸æ“šè¦–è¦ºåŒ–å„€è¡¨æ¿")

        # Streamlit åˆ†å‰²å´é‚Šæ¬„å’Œä¸»é«”ï¼Œè®“é¸æ“‡æ›´æ¸…æ™°
        col_select, col_chart = st.columns([1, 3])

        with col_select:
            st.subheader("é¸æ“‡åˆ†ææ¢ä»¶")

            # é¸æ“‡åœ–è¡¨é¡å‹
            chart_options = {
                'å–®æœˆæ’å (é•·æ¢åœ–)': '1',
                'è·¨æœˆæ¯”è¼ƒ (ä¸¦æ’é•·æ¢åœ–)': '2',
                'è¶¨å‹¢åˆ†æ (æŠ˜ç·šåœ–)': '3'
            }
            chart_name = st.selectbox('åœ–è¡¨é¡å‹', list(chart_options.keys()))
            chart_choice = chart_options[chart_name]

            # é¸æ“‡åˆ†ææ¬„ä½ (Metric)
            selected_col = st.selectbox('åˆ†ææŒ‡æ¨™', numeric_cols)

            # é¸æ“‡æœˆä»½ (åƒ…åœ¨å–®æœˆæ’åæ™‚éœ€è¦)
            available_months = sorted(analysis_df['å¹´æœˆä»£ç¢¼'].unique(), reverse=True)
            selected_month = None
            if chart_choice == '1':
                selected_month = st.selectbox('åˆ†ææœˆä»½', available_months)

            # é¸æ“‡ç¸£å¸‚ (Cities)
            all_cities = analysis_df['ç¸£å¸‚åˆ¥'].unique()
            selected_cities = st.multiselect(
                'æ¯”è¼ƒç¸£å¸‚ (å¤šé¸)',
                all_cities,
                default=list(all_cities)
            )

        with col_chart:
            st.subheader(f"ğŸ“Š {chart_name}")

            fig = None
            if chart_choice == '1':
                if selected_month:
                    fig = create_single_month_ranking(analysis_df, selected_month, selected_col)
                else:
                    st.info("è«‹é¸æ“‡æœˆä»½ä»¥é¡¯ç¤ºå–®æœˆæ’åã€‚")

            elif chart_choice == '2':
                if selected_cities:
                    fig = create_grouped_bar_comparison(analysis_df, selected_cities, selected_col)
                else:
                    st.info("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ç¸£å¸‚é€²è¡Œæ¯”è¼ƒã€‚")

            elif chart_choice == '3':
                if len(available_months) < 2:
                    st.error("è³‡æ–™ä¸è¶³ï¼Œç„¡æ³•ç¹ªè£½è¶¨å‹¢åœ– (è‡³å°‘éœ€è¦å…©å€‹æœˆä»½)")
                elif selected_cities:
                    fig = create_trend_comparison(analysis_df, selected_cities, selected_col)
                else:
                    st.info("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ç¸£å¸‚é€²è¡Œè¶¨å‹¢åˆ†æã€‚")

            # é¡¯ç¤ºåœ–è¡¨
            if fig:
                st.pyplot(fig)
            elif fig is None:
                pass


if __name__ == '__main__':
    streamlit_app()
